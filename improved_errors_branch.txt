
*** Improved type error branch ****   (Arthur Charguéraud, 2014/09/19)


Argumentation:
http://www.chargueraud.org/research/2014/ocaml_errors/ocaml_errors.pdf

Patch:
https://github.com/charguer/ocaml/compare/ocaml:4.02...improved-errors


Overview:

- Modified the behavior of the type-checking algorithm as follow: 
  (1) typecheck the code using the original algorithm
  (2) if an error occurs, typecheck the top-level definition that
      triggered the error using a new algorithm, that may (or may not)
      produce improved error messages.

- The new behavior can be turned off with the new flag "-old-type-errors"

- Remark: for backward compatibility, the "-strict-sequence" flag is
  still not turned on as default. However, if it is turned on, this flag 
  is taken into account for producing better messages.

- Many test files have been added to: testsuite/tests/typing-core-bugs/.


Implementation notes:

- CType.new_type_errors is a reference used to know whether we have already
  switched to the new algorithm or not.

- Function get_unification_error_easytype implements a better error reporting 
  message construction, with more components to the error messages.

- For detecting missing "rec" keywords, the original typechecking algorithm
  is modified in such a way as to add "ghost" bindings in the environment
  for variables that are bound non-recursively. The name of ghost variables
  is the name of the variable prefixed by a special string (a triple star).

- Function application is the most challenging modification. The new algorithm
  type-checks and generalized the arguments one by one.
  Functions extract_label_aux_easytype and type_applications_easytype
  track more type information than in the original type-checker. This part
  is not so pretty, but it could be simplified a lot the day we are ready
  to abandon the old error messages (or refactor its code a little bit).

- Pattern matching is modified, but more locally. Also, basic language 
  constructs are processed more carefully to produce better messages,
  in the new algorithm.

- An abbreviation "expr_pairs" in introduced in "type.ml" to factorize lot
  of copy-paste of "(type_expr * type_expr) list".


Remaining issues:

- If a top-level definition contains a type error, and this definition
  involves GADTs (in application or in pattern matching constructs), then
  the new algorithm will fail to report a useful error message.
  (The algorithm basically ignores the existence of GADTs).

- Note, however, that function applications involving "format" (e.g. printf)
  are properly detected.

- In rare occasions, the line returns get misplaced in error messages.
  I am not expert enough with "Format.fprintf" to solve these few remaining 
  cases. The messages remain readable, though.

- In testsuite/tests/typing-core-bugs/, some tests are marked as "pass"
  even though they shoud be marked as "fail". Why?


Open questions:

- If a file contains only the code "print_newline", without parentheses,
  should this file compile or not in mode "strict-sequence".

